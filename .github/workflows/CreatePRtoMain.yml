name: Create PR to Main

on:
  push:
    branches:
      - 'Dev'

jobs:
  test-and-create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Importante para ter acesso a todo o hist√≥rico
      
      # Configura√ß√£o espec√≠fica para Next.js + TypeScript
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      # Verifica√ß√£o de tipos TypeScript
      - name: TypeScript check
        run: npm run type-check || npm run tsc || echo "Executando verifica√ß√£o de tipos TypeScript"
        
      # Build do projeto Next.js
      - name: Build Next.js application
        run: npm run build
      
      # Extrair altera√ß√µes desde o √∫ltimo merge para Main
      - name: Get commits since last merge
        id: get_changes
        run: |
          LAST_MERGE=$(git log --merges --pretty=format:"%H" origin/main..origin/Dev | head -n 1)
          if [ -z "$LAST_MERGE" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" origin/main..origin/Dev)
          else
            CHANGES=$(git log --pretty=format:"- %s (%h)" $LAST_MERGE..origin/Dev)
          fi
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      # Criar Pull Request para Main
      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Promo√ß√£o Dev para Main"
          title: "üöÄ Promo√ß√£o Dev para Main ${{ steps.jira_tickets.outputs.tickets }}"
          body: |
            ## Solicita√ß√£o de Promo√ß√£o para Produ√ß√£o

            Este PR foi gerado automaticamente para promover as altera√ß√µes da branch Dev para Main.

            ### üîÑ Altera√ß√µes Inclu√≠das
            ${{ steps.get_changes.outputs.changes }}

            ### ‚úÖ Verifica√ß√µes
            - [x] Build Next.js executado com sucesso
            - [x] Verifica√ß√£o de tipos TypeScript
            - [x] Testes unit√°rios executados
            - [ ] Revis√£o de c√≥digo necess√°ria
            - [ ] Testes em ambiente de homologa√ß√£o realizados

            ### üìã Pr√≥ximos passos
            1. Revisar as altera√ß√µes
            2. Aprovar o PR
            3. Verificar deploy em produ√ß√£o
          base: main
          branch: automated-pr/dev-to-main
          labels: |
            automated
            promotion
            needs-review
            next-js

      # Adicionar revisores ao PR (opcional)
      - name: Add reviewers
        if: steps.create_pr.outputs.pull-request-number
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.create_pr.outputs.pull-request-number }}
          body: |
            @tech-leads Por favor, revisem este PR de promo√ß√£o para produ√ß√£o.
